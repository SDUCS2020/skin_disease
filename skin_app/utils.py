import os
import numpy as np
import tensorflow as tf
from PIL import Image
from django.conf import settings

# Define model path - make sure to place the model in this location
MODEL_PATH = os.path.join(settings.BASE_DIR, 'skin_app', 'model', 'dcsau_net_model.h5')

# Update disease classes based on your input
DISEASE_CLASSES = [
    'Экзема',
    'Бородавки, моллюск и другие вирусные инфекции',
    'Меланома',
    'Атопический дерматит',
    'Базальноклеточная карцинома (БКК)',
    'Меланоцитарные невусы (NV) ',
    'Доброкачественные поражения, подобные кератозу (BKL)',
    'Псориаз, лишай плоский и связанные заболевания',
    'Себорейные кератозы и другие доброкачественные опухоли',
    'Трихофития (лишай), кандидоз и другие грибковые инфекции',
]

# Disease recommendations based on your specified DISEASE_CLASSES
DISEASE_RECOMMENDATIONS = {
    'Экзема': {
        'description': 'Воспалительное заболевание кожи, характеризующееся зудом, покраснением и сухостью.',
        'recommendations': [
            'Избегайте контакта с раздражителями и аллергенами',
            'Используйте увлажняющие средства несколько раз в день',
            'Принимайте короткие теплые (не горячие) ванны или душ',
            'Используйте мягкие средства для очищения кожи без отдушек',
            'При сильном зуде проконсультируйтесь с дерматологом о применении топических кортикостероидов'
        ]
    },
    'Бородавки, моллюск и другие вирусные инфекции': {
        'description': 'Кожные инфекции вирусного происхождения, проявляющиеся папулами, бородавками или пузырьками.',
        'recommendations': [
            'Многие вирусные инфекции кожи проходят самостоятельно, особенно у людей с сильным иммунитетом',
            'Методы лечения бородавок: криотерапия, кюретаж, лазерная терапия, салициловая кислота',
            'Для контагиозного моллюска применяются кюретаж, криотерапия или местные препараты',
            'Избегайте расчесывания и травмирования высыпаний для предотвращения распространения',
            'Соблюдайте гигиену, не делитесь личными предметами',
            'Проконсультируйтесь с дерматологом для подбора оптимального метода лечения'
        ]
    },
    'Меланома': {
        'description': 'Серьезная форма рака кожи, возникающая из пигмент-продуцирующих клеток (меланоцитов).',
        'recommendations': [
            'Требуется немедленное обращение к онкологу или дерматологу',
            'Раннее лечение критически важно для предотвращения метастазирования',
            'Хирургическое удаление с последующим лечением в зависимости от стадии',
            'Регулярно проводите самообследование кожи',
            'Избегайте чрезмерного пребывания на солнце и используйте солнцезащитный крем с высоким SPF',
            'Регулярно посещайте дерматолога для профилактических осмотров'
        ]
    },
    'Атопический дерматит': {
        'description': 'Хронический тип экземы, характеризующийся сухостью, зудом и воспалением кожи.',
        'recommendations': [
            'Поддерживайте кожу увлажненной, используйте кремы и мази без ароматизаторов',
            'Избегайте контакта с известными раздражителями (шерсть, некоторые моющие средства)',
            'Носите свободную одежду из натуральных тканей',
            'Контролируйте стресс, который может провоцировать обострения',
            'Применяйте назначенные врачом противовоспалительные препараты',
            'Избегайте расчесывания, чтобы предотвратить инфицирование'
        ]
    },
    'Базальноклеточная карцинома (БКК)': {
        'description': 'Наиболее распространенный тип рака кожи, медленно растущий и редко метастазирующий.',
        'recommendations': [
            'Обязательно обратитесь к дерматологу или онкологу для лечения',
            'Стандартное лечение включает хирургическое удаление',
            'В некоторых случаях применяются криотерапия, фотодинамическая терапия или местные препараты',
            'Защищайте кожу от солнца, используя солнцезащитный крем и защитную одежду',
            'Регулярно проводите самообследование кожи для выявления новых поражений',
            'Посещайте дерматолога для периодических осмотров'
        ]
    },
    'Меланоцитарные невусы (NV) ': {
        'description': 'Доброкачественные скопления меланоцитов (пигментных клеток), обычно известные как родинки.',
        'recommendations': [
            'Большинство родинок безвредны и не требуют лечения',
            'Следите за изменениями формы, размера, цвета или симметрии (правило ABCDE)',
            'Защищайте родинки от солнца, чтобы предотвратить повреждение',
            'Фотографируйте крупные или необычные родинки для отслеживания изменений',
            'При заметных изменениях обратитесь к дерматологу',
            'Избегайте травмирования родинок'
        ]
    },
    'Доброкачественные поражения, подобные кератозу (BKL)': {
        'description': 'Группа доброкачественных кожных образований, включающая себорейные кератозы и солнечное лентиго.',
        'recommendations': [
            'Данные образования обычно безвредны и не требуют лечения',
            'При косметическом дискомфорте можно провести удаление',
            'Методы удаления: криотерапия, кюретаж, электрокоагуляция или лазерная терапия',
            'Защищайте кожу от солнца для предотвращения появления новых образований',
            'Обратитесь к дерматологу, если образование меняет вид, кровоточит или вызывает боль',
            'Регулярно осматривайте кожу для выявления изменений'
        ]
    },
    'Псориаз, лишай плоский и связанные заболевания': {
        'description': 'Группа хронических воспалительных заболеваний кожи, характеризующихся чешуйчатыми высыпаниями и зудом.',
        'recommendations': [
            'Используйте увлажняющие средства для уменьшения сухости и шелушения',
            'Применяйте топические кортикостероиды или другие противовоспалительные препараты по назначению врача',
            'При псориазе может быть эффективна фототерапия (УФ-лечение)',
            'Избегайте известных триггеров: стресс, повреждения кожи, некоторые лекарства',
            'Для тяжелых форм могут назначаться системные препараты (метотрексат, биологические препараты)',
            'Регулярно посещайте дерматолога для мониторинга состояния и корректировки лечения'
        ]
    },
    'Себорейные кератозы и другие доброкачественные опухоли': {
        'description': 'Доброкачественные кожные новообразования, часто выглядящие как "наклеенные" на кожу коричневатые бляшки.',
        'recommendations': [
            'Большинство себорейных кератозов безвредны и не требуют лечения',
            'Удаление может проводиться по косметическим причинам или при раздражении',
            'Методы удаления: криотерапия, кюретаж, электродесикация, лазерная терапия',
            'Не пытайтесь удалить образования самостоятельно',
            'Обратитесь к дерматологу, если образование быстро растет, меняет цвет или кровоточит',
            'Дифференциальная диагностика с меланомой может потребовать биопсии'
        ]
    },
    'Трихофития (лишай), кандидоз и другие грибковые инфекции': {
        'description': 'Группа грибковых инфекций кожи, проявляющихся в виде зудящих, чешуйчатых и красных высыпаний.',
        'recommendations': [
            'Применяйте противогрибковые препараты местного действия (кремы, мази) согласно инструкции',
            'В тяжелых случаях или при поражении волосистой части головы могут назначаться пероральные противогрибковые средства',
            'Поддерживайте кожу сухой и чистой, особенно в складках',
            'Избегайте тесной одежды и обуви, предпочитайте натуральные ткани',
            'Не делитесь личными предметами (полотенца, расчески, одежда)',
            'Завершите полный курс лечения, даже если симптомы исчезли раньше'
        ]
    }
}

def load_model():
    """Load the trained model"""
    try:
        model = tf.keras.models.load_model(MODEL_PATH)
        return model
    except Exception as e:
        print(f"Error loading model: {e}")
        return None

def preprocess_image(image_path, target_size=(128, 128)):
    """Preprocess image for prediction"""
    try:
        img = Image.open(image_path)
        img = img.resize(target_size)
        img_array = np.array(img)
        img_array = tf.keras.applications.mobilenet_v2.preprocess_input(img_array)
        img_array = np.expand_dims(img_array, axis=0)  # Add batch dimension
        return img_array
    except Exception as e:
        print(f"Error preprocessing image: {e}")
        return None

def predict_disease(image_path):
    """Predict skin disease from image"""
    model = load_model()
    if model is None:
        return None, 0
    
    img_array = preprocess_image(image_path)
    if img_array is None:
        return None, 0
    
    try:
        prediction = model.predict(img_array)
        predicted_class_idx = np.argmax(prediction[0])
        confidence = float(prediction[0][predicted_class_idx] * 100)
        
        disease_name = DISEASE_CLASSES[predicted_class_idx]
        return disease_name, confidence
    except Exception as e:
        print(f"Error during prediction: {e}")
        return None, 0

def get_disease_info(disease_name):
    """Get disease information and recommendations"""
    if disease_name in DISEASE_RECOMMENDATIONS:
        return DISEASE_RECOMMENDATIONS[disease_name]
    else:
        return {
            'description': 'Информация о данном заболевании отсутствует.',
            'recommendations': ['Проконсультируйтесь с дерматологом.']
        }
